<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>页面分配基本流程 | 探索者</title>
    <meta name="description" content="博观而约取,厚积而薄发">
    <link rel="preload stylesheet" href="/assets/style.28e1808c.css" as="style">
    <link rel="modulepreload" href="/assets/app.4b3fa60d.js">
    <link rel="modulepreload" href="/assets/linux_memory_buddy_alloc-pages_alloc-pages.md.d95e3be6.lean.js">
    
    <script id="check-dark-light">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-93a960b4><!--[--><!--]--><!--[--><span tabindex="-1" data-v-151f2593></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-151f2593> Skip to content </a><!--]--><!----><header class="VPNav" data-v-93a960b4 data-v-0fa0e57d><div class="VPNavBar has-sidebar" data-v-0fa0e57d data-v-be450ad9><div class="container" data-v-be450ad9><div class="title" data-v-be450ad9><div class="VPNavBarTitle has-sidebar" data-v-be450ad9 data-v-6d2fb2d9><a class="title" href="/" data-v-6d2fb2d9><!--[--><!--]--><!--[--><img class="VPImage logo" src="/hero.png" alt data-v-6db2186b><!--]--><!--[-->探索者<!--]--><!--[--><!--]--></a></div></div><div class="content" data-v-be450ad9><div class="curtain" data-v-be450ad9></div><div class="content-body" data-v-be450ad9><!--[--><!--]--><!----><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-be450ad9 data-v-bdedfc22><span id="main-nav-aria-label" class="visually-hidden" data-v-bdedfc22>Main Navigation</span><!--[--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-bdedfc22 data-v-96001b6b><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-96001b6b><span class="text" data-v-96001b6b><!----> 内核 <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-96001b6b><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-96001b6b><div class="VPMenu" data-v-96001b6b data-v-e7ea1737><div class="items" data-v-e7ea1737><!--[--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-a5bbb52c><a class="VPLink link" href="/linux/memory/common/modle/modle.html" data-v-a5bbb52c data-v-30c06bd3><!--[-->内存管理<!--]--><!----></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-a5bbb52c><a class="VPLink link" href="/linux/process/pelt/pelt.html" data-v-a5bbb52c data-v-30c06bd3><!--[-->进程管理<!--]--><!----></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/about/about.html" data-v-bdedfc22 data-v-95f5d58b data-v-30c06bd3><!--[-->关于<!--]--><!----></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-be450ad9 data-v-da3f667a><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" aria-checked="false" data-v-da3f667a data-v-0d529b6d data-v-f3c41672><span class="check" data-v-f3c41672><span class="icon" data-v-f3c41672><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-0d529b6d><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-0d529b6d><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-be450ad9 data-v-2ab2a029 data-v-f6988cfb><!--[--><a class="VPSocialLink" href="https://github.com/zaiqiang-dong/blog" target="_blank" rel="noopener" data-v-f6988cfb data-v-e57698f6><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><a class="VPSocialLink" href target="_blank" rel="noopener" data-v-f6988cfb data-v-e57698f6><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Twitter</title><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/></svg></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-be450ad9 data-v-f38c483a data-v-96001b6b><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-96001b6b><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-96001b6b><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-96001b6b><div class="VPMenu" data-v-96001b6b data-v-e7ea1737><!----><!--[--><!--[--><!----><div class="group" data-v-f38c483a><div class="item appearance" data-v-f38c483a><p class="label" data-v-f38c483a>Appearance</p><div class="appearance-action" data-v-f38c483a><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" aria-checked="false" data-v-f38c483a data-v-0d529b6d data-v-f3c41672><span class="check" data-v-f3c41672><span class="icon" data-v-f3c41672><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-0d529b6d><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-0d529b6d><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><div class="group" data-v-f38c483a><div class="item social-links" data-v-f38c483a><div class="VPSocialLinks social-links-list" data-v-f38c483a data-v-f6988cfb><!--[--><a class="VPSocialLink" href="https://github.com/zaiqiang-dong/blog" target="_blank" rel="noopener" data-v-f6988cfb data-v-e57698f6><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><a class="VPSocialLink" href target="_blank" rel="noopener" data-v-f6988cfb data-v-e57698f6><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Twitter</title><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/></svg></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-be450ad9 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><!----></header><div class="VPLocalNav" data-v-93a960b4 data-v-2817d72e><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-2817d72e><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-2817d72e><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-2817d72e>Menu</span></button><a class="top-link" href="#" data-v-2817d72e>Return to top</a></div><aside class="VPSidebar" data-v-93a960b4 data-v-c79ccefa><div class="curtain" data-v-c79ccefa></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-c79ccefa><span class="visually-hidden" id="sidebar-aria-label" data-v-c79ccefa> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-c79ccefa><section class="VPSidebarItem level-0" data-v-c79ccefa data-v-b05232f3><div class="item" role="button" data-v-b05232f3><div class="indicator" data-v-b05232f3></div><a class="VPLink link" data-v-b05232f3 data-v-30c06bd3><!--[--><h2 class="text" data-v-b05232f3>公共部分</h2><!--]--><!----></a><!----></div><div class="items" data-v-b05232f3><!--[--><div class="VPSidebarItem level-1 is-link" data-v-b05232f3 data-v-b05232f3><div class="item" data-v-b05232f3><div class="indicator" data-v-b05232f3></div><a class="VPLink link link" href="/linux/memory/common/modle/modle.html" data-v-b05232f3 data-v-30c06bd3><!--[--><p class="text" data-v-b05232f3>内存模型</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-c79ccefa><section class="VPSidebarItem level-0" data-v-c79ccefa data-v-b05232f3><div class="item" role="button" data-v-b05232f3><div class="indicator" data-v-b05232f3></div><a class="VPLink link" data-v-b05232f3 data-v-30c06bd3><!--[--><h2 class="text" data-v-b05232f3>伙伴系统</h2><!--]--><!----></a><!----></div><div class="items" data-v-b05232f3><!--[--><div class="VPSidebarItem level-1 is-link" data-v-b05232f3 data-v-b05232f3><div class="item" data-v-b05232f3><div class="indicator" data-v-b05232f3></div><a class="VPLink link link" href="/linux/memory/buddy/alloc-flags/alloc-flags.html" data-v-b05232f3 data-v-30c06bd3><!--[--><p class="text" data-v-b05232f3>分配掩码</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-93a960b4 data-v-0bd490fb><div class="VPDoc has-sidebar has-aside" data-v-0bd490fb data-v-c5936a1e><div class="container" data-v-c5936a1e><div class="aside" data-v-c5936a1e><div class="aside-curtain" data-v-c5936a1e></div><div class="aside-container" data-v-c5936a1e><div class="aside-content" data-v-c5936a1e><div class="VPDocAside" data-v-c5936a1e data-v-cdc66372><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" data-v-cdc66372 data-v-5dd9d5f6><div class="content" data-v-5dd9d5f6><div class="outline-marker" data-v-5dd9d5f6></div><div class="outline-title" data-v-5dd9d5f6>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-5dd9d5f6><span class="visually-hidden" id="doc-outline-aria-label" data-v-5dd9d5f6> Table of Contents for current page </span><ul class="root" data-v-5dd9d5f6 data-v-1188541a><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-cdc66372></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-c5936a1e><div class="content-container" data-v-c5936a1e><!--[--><!--]--><main class="main" data-v-c5936a1e><div style="position:relative;" class="vp-doc _linux_memory_buddy_alloc-pages_alloc-pages" data-v-c5936a1e><div><h1 id="页面分配基本流程" tabindex="-1">页面分配基本流程 <a class="header-anchor" href="#页面分配基本流程" aria-hidden="true">#</a></h1><hr><table><thead><tr><th>软件版本</th><th>硬件版本</th><th>更新内容</th></tr></thead><tbody><tr><td>linux 5.8.18</td><td>arm64</td><td></td></tr></tbody></table><hr><p>本章只是梳理页面分配流程，不存在代码思想的解析。</p><h2 id="_1-接口函数" tabindex="-1">1. 接口函数 <a class="header-anchor" href="#_1-接口函数" aria-hidden="true">#</a></h2><h3 id="_1-1-alloc-page" tabindex="-1">1.1 alloc_page <a class="header-anchor" href="#_1-1-alloc-page" aria-hidden="true">#</a></h3><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">alloc_page</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">gfp_mask</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">alloc_pages</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>从代码可以看出<code>alloc_page</code>最终调用的是<code>alloc_pages</code>,只是在第二个参数的位置写0,表示 <mjx-container class="MathJax" jax="SVG" style="direction:ltr;position:relative;"><svg style="overflow:visible;min-height:1px;min-width:1px;vertical-align:0;" xmlns="http://www.w3.org/2000/svg" width="2.119ex" height="1.887ex" role="img" focusable="false" viewBox="0 -833.9 936.6 833.9" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z" style="stroke-width:3;"></path></g><g data-mml-node="mn" transform="translate(533,363) scale(0.707)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" style="stroke-width:3;"></path></g></g></g></g></svg><!----></mjx-container>,也就是1个页面。</p><h3 id="_1-2-get-free-pages" tabindex="-1">1.2 __get_free_pages <a class="header-anchor" href="#_1-2-get-free-pages" aria-hidden="true">#</a></h3><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">unsigned</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__get_free_pages</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">gfp_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">unsigned</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">order</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> page </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">page</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	page </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">alloc_pages</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">gfp_mask </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">~</span><span style="color:#F07178;">__GFP_HIGHMEM</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> order</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(!</span><span style="color:#F07178;">page</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">unsigned</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">long</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">page_address</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">page</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>同样的<code>__get_free_pages</code>也是调用了调用了<code>alloc_pages</code>,只是在<code>gfp_mask</code>参数部分清除了<code>__GFP_HIGHMEM</code>,也就是不能从高端内存部分分配。这里最后一行<code>page_address</code>,表示返回的是页面的虚拟地址。</p><h3 id="_1-3-get-free-page" tabindex="-1">1.3 __get_free_page <a class="header-anchor" href="#_1-3-get-free-page" aria-hidden="true">#</a></h3><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__get_free_page</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">gfp_mask</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> \</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#82AAFF;">__get_free_pages</span><span style="color:#89DDFF;">((</span><span style="color:#A6ACCD;">gfp_mask</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这个很明显调用了<code>__get_free_pages</code>,只是页面个数为1.</p><h3 id="_1-4-get-zeroed-page" tabindex="-1">1.4 get_zeroed_page <a class="header-anchor" href="#_1-4-get-zeroed-page" aria-hidden="true">#</a></h3><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">unsigned</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">get_zeroed_page</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">gfp_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">gfp_mask</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">__get_free_pages</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">gfp_mask </span><span style="color:#89DDFF;">|</span><span style="color:#F07178;"> __GFP_ZERO</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这个函数调用了上面的<code>__get_free_pages</code>,只是设置了<code>__GFP_ZERO</code>,表示需要将页面进行清0处理。另外页面个数部分为0,表示只分配一个页面。</p><h3 id="_1-5-get-dma-pages" tabindex="-1">1.5 __get_dma_pages <a class="header-anchor" href="#_1-5-get-dma-pages" aria-hidden="true">#</a></h3><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__get_dma_pages</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">order</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> \</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#82AAFF;">__get_free_pages</span><span style="color:#89DDFF;">((</span><span style="color:#A6ACCD;">gfp_mask</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> GFP_DMA</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">order</span><span style="color:#89DDFF;">))</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>这里同样调用了<code>__get_free_pages</code>,只是设置了<code>GFP_DMA</code>,表示从DMA内存分区进行内存分配。</p><h2 id="_2-alloc-pages" tabindex="-1">2. alloc_pages <a class="header-anchor" href="#_2-alloc-pages" aria-hidden="true">#</a></h2><p>从上面的接口分析中可以看出所有的接口最终都是调用了<code>alloc_pages</code>,下面我重点分析这个函数。</p><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">#ifdef</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">CONFIG_NUMA</span></span>
<span class="line"><span style="color:#C792EA;">extern</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> page </span><span style="color:#89DDFF;">*</span><span style="color:#82AAFF;">alloc_pages_current</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">gfp_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">unsigned</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">order</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">inline</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> page </span><span style="color:#89DDFF;">*</span></span>
<span class="line"><span style="color:#82AAFF;">alloc_pages</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">gfp_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">unsigned</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">order</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">alloc_pages_current</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> order</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#C792EA;">extern</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> page </span><span style="color:#89DDFF;">*</span><span style="color:#82AAFF;">alloc_pages_vma</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">gfp_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">order</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">			</span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> vm_area_struct </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">vma</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">unsigned</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">addr</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">			</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">node</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">bool</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">hugepage</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">alloc_hugepage_vma</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">vma</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">addr</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">order</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> \</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#82AAFF;">alloc_pages_vma</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> order</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> vma</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> addr</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">numa_node_id</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#else</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">alloc_pages</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">order</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> \</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#82AAFF;">alloc_pages_node</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">numa_node_id</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> order</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">alloc_pages_vma</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">order</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">vma</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">addr</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">node</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">false</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">\</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#82AAFF;">alloc_pages</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> order</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">alloc_hugepage_vma</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">vma</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">addr</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">order</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> \</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#82AAFF;">alloc_pages</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> order</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#endif</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>从宏定义可以看出在<code>NUMA</code>和非<code>NUMA</code>,存在不同，我们这里按非<code>NUMA</code>来分析。也就是如下：</p><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">alloc_pages</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">order</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> \</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#82AAFF;">alloc_pages_node</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">numa_node_id</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> order</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>最终调用的是<code>alloc_pages_node</code>,这里的node是<code>NUMA</code>节点。这里<code>numa_node_id</code>返回的是当前<code>CPU</code>所在的<code>NUMA</code>节点，我们这里是讨论的是非<code>NUMA</code>平台，所以这里的节点值为0。</p><h3 id="_2-1-alloc-pages-node" tabindex="-1">2.1 alloc_pages_node <a class="header-anchor" href="#_2-1-alloc-pages-node" aria-hidden="true">#</a></h3><p>从上面的分析最终是调用了<code>alloc_pages_node</code>,代码如下：</p><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">inline</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> page </span><span style="color:#89DDFF;">*</span><span style="color:#82AAFF;">alloc_pages_node</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">nid</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">gfp_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">gfp_mask</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">						</span><span style="color:#C792EA;">unsigned</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">order</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">nid </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> NUMA_NO_NODE</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">		nid </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">numa_mem_id</span><span style="color:#89DDFF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">__alloc_pages_node</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">nid</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> order</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>代码很简单就是调用<code>__alloc_pages_node</code></p><h3 id="_2-2-alloc-pages-node" tabindex="-1">2.2 __alloc_pages_node <a class="header-anchor" href="#_2-2-alloc-pages-node" aria-hidden="true">#</a></h3><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">inline</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> page </span><span style="color:#89DDFF;">*</span></span>
<span class="line"><span style="color:#82AAFF;">__alloc_pages_node</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">nid</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">gfp_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">unsigned</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">order</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	/* 保证nid的合法性 */</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#82AAFF;">VM_BUG_ON</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">nid </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">||</span><span style="color:#F07178;"> nid </span><span style="color:#89DDFF;">&gt;=</span><span style="color:#F07178;"> MAX_NUMNODES</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#82AAFF;">VM_WARN_ON</span><span style="color:#89DDFF;">((</span><span style="color:#F07178;">gfp_mask </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> __GFP_THISNODE</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!</span><span style="color:#82AAFF;">node_online</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">nid</span><span style="color:#89DDFF;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">__alloc_pages</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> order</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> nid</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_2-3-alloc-pages" tabindex="-1">2.3 __alloc_pages <a class="header-anchor" href="#_2-3-alloc-pages" aria-hidden="true">#</a></h3><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> page </span><span style="color:#89DDFF;">*</span></span>
<span class="line"><span style="color:#82AAFF;">__alloc_pages_nodemask</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">gfp_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">unsigned</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">order</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">preferred_nid</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">							</span><span style="color:#FFCB6B;">nodemask_t</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">nodemask</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">inline</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> page </span><span style="color:#89DDFF;">*</span></span>
<span class="line"><span style="color:#82AAFF;">__alloc_pages</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">gfp_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">unsigned</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">order</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">preferred_nid</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">__alloc_pages_nodemask</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> order</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> preferred_nid</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">NULL);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>上面代码很简单，<code>__alloc_pages_nodemask</code>是真正的内存分配函数。</p><h2 id="_3-alloc-pages-nodemask" tabindex="-1">3. __alloc_pages_nodemask <a class="header-anchor" href="#_3-alloc-pages-nodemask" aria-hidden="true">#</a></h2><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> page </span><span style="color:#89DDFF;">*</span></span>
<span class="line"><span style="color:#82AAFF;">__alloc_pages_nodemask</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">gfp_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">unsigned</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">order</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">preferred_nid</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">							</span><span style="color:#FFCB6B;">nodemask_t</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">nodemask</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> page </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">page</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#C792EA;">unsigned</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">int</span><span style="color:#F07178;"> alloc_flags </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> ALLOC_WMARK_LOW</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#FFCB6B;">gfp_t</span><span style="color:#F07178;"> alloc_mask</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;"> /* The gfp_t that was actually used for allocation */</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> alloc_context ac </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * There are several places where we assume that the order value is sane</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * so bail out early if the request is out of bound.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 */</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">unlikely</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">order </span><span style="color:#89DDFF;">&gt;=</span><span style="color:#F07178;"> MAX_ORDER</span><span style="color:#89DDFF;">))</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#82AAFF;">WARN_ON_ONCE</span><span style="color:#89DDFF;">(!(</span><span style="color:#F07178;">gfp_mask </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> __GFP_NOWARN</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">NULL;</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * gfp_allowed_mask 在系统启动中为GFP_BOOT_MASK</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * #define GFP_BOOT_MASK (__GFP_BITS_MASK &amp; ~(__GFP_RECLAIM|__GFP_IO|__GFP_FS))</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 *</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * 后设置为如下</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * gfp_allowed_mask = __GFP_BITS_MASK; = 0x7FFFFF;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 *</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 */</span></span>
<span class="line"><span style="color:#F07178;">	gfp_mask </span><span style="color:#89DDFF;">&amp;=</span><span style="color:#F07178;"> gfp_allowed_mask</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	alloc_mask </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> gfp_mask</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * prepare_alloc_pages 主要是初始化ac，具体见函数实现</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 */</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(!</span><span style="color:#82AAFF;">prepare_alloc_pages</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> order</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> preferred_nid</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> nodemask</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;">ac</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;">alloc_mask</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;">alloc_flags</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">NULL;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * 这里主要是要找一个最好的zone用于后面分配内存</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 *</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * */</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#82AAFF;">finalise_ac</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;">ac</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * Forbid the first pass from falling back to types that fragment</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * memory until all local zones are considered.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 */</span></span>
<span class="line"><span style="color:#F07178;">	alloc_flags </span><span style="color:#89DDFF;">|=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">alloc_flags_nofragment</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ac</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">preferred_zoneref</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">zone</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> gfp_mask</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * 大部分情况会走这里</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 */</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	/* First allocation attempt */</span></span>
<span class="line"><span style="color:#F07178;">	page </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">get_page_from_freelist</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">alloc_mask</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> order</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> alloc_flags</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;">ac</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">likely</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">page</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;font-style:italic;">goto</span><span style="color:#F07178;"> out</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * Apply scoped allocation constraints. This is mainly about GFP_NOFS</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * resp. GFP_NOIO which has to be inherited for all allocation requests</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * from a particular context which has been marked by</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * memalloc_no{fs,io}_{save,restore}.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 */</span></span>
<span class="line"><span style="color:#F07178;">	alloc_mask </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">current_gfp_context</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">gfp_mask</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#A6ACCD;">ac</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">spread_dirty_pages</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">false;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * Restore the original nodemask if it was potentially replaced with</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * &amp;cpuset_current_mems_allowed to optimize the fast-path attempt.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 */</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#A6ACCD;">ac</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">nodemask</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> nodemask</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * 系统内存不足，先回收再分配</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	page </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">__alloc_pages_slowpath</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">alloc_mask</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> order</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;">ac</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">out:</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">memcg_kmem_enabled</span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">gfp_mask </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> __GFP_ACCOUNT</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> page </span><span style="color:#89DDFF;">&amp;&amp;</span></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#82AAFF;">unlikely</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">__memcg_kmem_charge_page</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">page</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> order</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">))</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#82AAFF;">__free_pages</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">page</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> order</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">		page </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">NULL;</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#82AAFF;">trace_mm_page_alloc</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">page</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> order</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> alloc_mask</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">ac</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">migratetype</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> page</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br></div></div><h2 id="_4-小结" tabindex="-1">4. 小结 <a class="header-anchor" href="#_4-小结" aria-hidden="true">#</a></h2><p>本文只是梳理了大体的内存页面分配的思路，从上面代码分析中可以看到<code>__alloc_pages_nodemask</code>才是真正的分配函数，无论你调用了那个接口函数，最终都会调到这里。</p><hr><div class="tip custom-block"><p class="custom-block-title">提示</p><p>欢迎评论、探讨,如果发现错误请指正。转载请注明出处！ <a href="http://www.tsz.wiki" target="_blank" rel="noreferrer">探索者</a></p></div><hr><!----></div></div></main><!--[--><!--]--><footer class="VPDocFooter" data-v-c5936a1e data-v-e033cd21><!----><div class="prev-next" data-v-e033cd21><div class="pager" data-v-e033cd21><!----></div><div class="pager" data-v-e033cd21><a class="pager-link next" href="/linux/memory/common/modle/modle.html" data-v-e033cd21><span class="desc" data-v-e033cd21>Next page</span><span class="title" data-v-e033cd21>内存模型</span></a></div></div></footer><!--[--><!--]--></div></div></div></div></div><footer class="VPFooter has-sidebar" data-v-93a960b4 data-v-d24360a6><div class="container" data-v-d24360a6><p class="message" data-v-d24360a6>Released under the MIT License.</p><p class="copyright" data-v-d24360a6>Copyright © 2019-present Zaiqiang Dong</p></div></footer><!--[--><!--]--></div></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"hardware_protocol_tcpip_noting.md\":\"3a9139bd\",\"coding_algorithm_noting.md\":\"37346a71\",\"hardware_protocol_bluetooth_noting.md\":\"a86768c3\",\"hardware_readme.md\":\"aca7334d\",\"hardware_protocol_can_noting.md\":\"3db981d5\",\"hardware_protocol_noting.md\":\"a74c2efd\",\"coding_language_python_parallel_noting.md\":\"73bfb8ae\",\"coding_language_common_word-dword-qword_word-dword-qword.md\":\"74c295f3\",\"hardware_protocol_sr-iov_noting.md\":\"8e63eccc\",\"coding_language_asm-arm_code_src_inline-asm_readme.md\":\"ab76cc0a\",\"coding_language_python_noting.md\":\"c2a7be62\",\"coding_language_asm-arm_code_src_base_instructions_pseudo_readme.md\":\"ed11b058\",\"car_noting.md\":\"0b40763c\",\"coding_datastruct_noting.md\":\"99c9e3ae\",\"coding_readme.md\":\"3918df1a\",\"coding_language_asm-arm_code_src_base_instructions_coprocessor_readme.md\":\"6a125b93\",\"coding_language_c-c___libs_glib_noting.md\":\"2fab4694\",\"coding_language_asm-arm_code_src_base_instructions_branch_readme.md\":\"7957590a\",\"hardware_protocol_usb_noting.md\":\"18ba71f9\",\"about_about.md\":\"df7bcb6c\",\"linux_readme.md\":\"81401923\",\"back_readme.md\":\"8b2c1be3\",\"hardware_ram_cache_noting.md\":\"d6b81d75\",\"linux_driver_noting.md\":\"445ad1c4\",\"coding_language_asm-arm_code_readme.md\":\"668d6dc2\",\"coding_language_asm-arm_code_src_base_instructions_miscellaneous_readme.md\":\"d8e57321\",\"hardware_cpu_arm_intro_intro.md\":\"19945713\",\"coding_language_shell_parallel_noting.md\":\"50dd0b6e\",\"coding_language_noting.md\":\"b1ed810d\",\"coding_language_c-c___parallel_noting.md\":\"090ab2be\",\"hardware_addressspace_common_intro_intro.md\":\"a4bb7dbd\",\"hardware_addressspace_x86_x86addrspace_x86addrspace.md\":\"2073eca9\",\"car_readme.md\":\"ada50ac1\",\"index.md\":\"de04dbeb\",\"linux_mechanism_signal_noting.md\":\"af7c7c75\",\"linux_mechanism_ftrace_file-interface_file-interface.md\":\"d09d2d88\",\"hardware_ram_memory_arm_vmsa_vmsa_intro_vmsa_intro.md\":\"2de5a6bb\",\"readme.md\":\"7bfa31fc\",\"coding_skills_noting.md\":\"d8612497\",\"hardware_cpu_common_topology_topology.md\":\"792c7ab9\",\"hardware_ram_cache_cache.md\":\"a67b356e\",\"linux_driver_cpu_cpu.md\":\"82d0e297\",\"linux_mechanism_noting.md\":\"7ae48d02\",\"hardware_ram_memory_arm_vmsa_vmsa_page_vmsa_page.md\":\"0626e613\",\"linux_filesystem_initrd-principles_initrd-principles.md\":\"30303f3c\",\"linux_interrupt_common_interrupt-sleep_interrupt-sleep.md\":\"5a35e00c\",\"linux_memory_buddy_alloc-pages_alloc-pages.md\":\"d95e3be6\",\"linux_filesystem_make-ubuntu-initrd_make-ubuntu-initrd.md\":\"121ff5e5\",\"linux_memory_buddy_alloc-flags_alloc-flags.md\":\"bcd8bfc9\",\"linux_memory_common_modle_modle.md\":\"e7ed17d8\",\"linux_memory_buddy_zone-split_zone-split.md\":\"71275513\",\"linux_memory_buddy_wartermark_watermark.md\":\"1dccdb35\",\"linux_parallel_barriers_principle_principle.md\":\"a0a3d3ee\",\"linux_process_balance_cal-balance_cal-balance.md\":\"9b7c6f56\",\"linux_power_noting.md\":\"4e836c0a\",\"linux_parallel_rcu_rcu.md\":\"c3d845a7\",\"linux_parallel_barriers_overview_overview.md\":\"f18731eb\",\"linux_memory_slub_slub_order_slub_order.md\":\"dc582dc7\",\"linux_process_preemption_preemption.md\":\"fec95bbc\",\"linux_memory_stack_stack-analysis.md\":\"88686346\",\"virtualization_x86_qemu_io_vhost_noting.md\":\"02d853cf\",\"tools_builder_builder.md\":\"1090d891\",\"tools_cmd_cmd.md\":\"b575ac35\",\"virtualization_x86_tools_virt-install_virt-install.md\":\"5403738e\",\"virtualization_x86_qemu_io_sr-iov_noting.md\":\"590604a2\",\"virtualization_x86_qemu_io_virtio_noting.md\":\"530aa1c5\",\"virtualization_x86_kvm_interrupt_full_noting.md\":\"562026cc\",\"virtualization_x86_kvm_net_noting.md\":\"2c97de5c\",\"virtualization_readme.md\":\"0e4ed827\",\"virtualization_arm_theory_cpu_m.md\":\"76d9a369\",\"tools_debugger_bcc_memleak_tip.md\":\"1e855c35\",\"misc_readme.md\":\"bf630fce\",\"linux_timesystem_noting.md\":\"ac81207e\",\"tools_cmd_char_tr.md\":\"698c73d6\",\"virtualization_x86_kvm_interrupt_para_noting.md\":\"05d8582c\",\"virtualization_x86_theory_net_noting.md\":\"52bbf428\",\"virtualization_x86_theory_memory_noting.md\":\"10077b78\",\"virtualization_x86_qemu_io_full_noting.md\":\"9eabfcd1\",\"virtualization_x86_theory_io_sr-iov_noting.md\":\"0aa28688\",\"virtualization_x86_kvm_cpu_noting.md\":\"f31b218e\",\"virtualization_x86_qemu_io_passthrough_noting.md\":\"86ad07f2\",\"virtualization_x86_kvm_io_sr-iov_noting.md\":\"2ea871de\",\"tools_debugger_crash_vmcore_vmcore.md\":\"43d0ea58\",\"tools_cmd_char_sed.md\":\"be8cbd65\",\"virtualization_arm_theory_memory_m.md\":\"63c633aa\",\"tools_debugger_gdb_build-gdb_build-gdb.md\":\"de1da06d\",\"tools_builder_elf_elf-format_elf-format.md\":\"3bcd13d9\",\"virtualization_arm_theory_interrupt_m.md\":\"16a98a34\",\"virtualization_arm_theory_net_m.md\":\"4abc5415\",\"virtualization_arm_theory_storage_m.md\":\"93a83a5c\",\"tools_debugger_gdb_kernel-gdb_kernel-gdb.md\":\"50fef81e\",\"tools_builder_common_gccmakecmake_gccmakecmake.md\":\"1e28c914\",\"misc_desktop-system_noting.md\":\"44994465\",\"tools_debugger_debugger.md\":\"dfe9c8c7\",\"virtualization_x86_kvm_memory_noting.md\":\"d1ee9832\",\"tools_version_version.md\":\"d6505b7c\",\"linux_process_priority_priority.md\":\"833a16dd\",\"virtualization_x86_qemu_interrupt_para_noting.md\":\"879447af\",\"virtualization_x86_qemu_cpu_noting.md\":\"6b780912\",\"virtualization_x86_qemu_component_qom_qom.md\":\"244dab27\",\"virtualization_x86_qemu_memory_noting.md\":\"b75cc89d\",\"virtualization_x86_qemu_interrupt_int-mapping_noting.md\":\"761f5667\",\"virtualization_x86_qemu_interrupt_full_noting.md\":\"80676f4f\",\"virtualization_x86_kvm_io_full_noting.md\":\"8ff0b05b\",\"tools_builder_common_front-backend_front-backend.md\":\"44f26ef1\",\"virtualization_x86_theory_cpu_noting.md\":\"8073a35b\",\"tools_editor_editor.md\":\"52679a50\",\"virtualization_x86_kvm_io_vhost_noting.md\":\"2a894930\",\"virtualization_x86_kvm_io_virtio_noting.md\":\"88dcc1af\",\"tools_builder_binutils_objdump_objdump.md\":\"182ff099\",\"tools_readme.md\":\"bd922f17\",\"virtualization_x86_kvm_io_passthrough_noting.md\":\"05bce673\",\"virtualization_x86_theory_interrupt_para_noting.md\":\"0fd42237\",\"virtualization_x86_theory_io_vhost_noting.md\":\"fa377049\",\"virtualization_x86_theory_io_passthrough_noting.md\":\"9dffe334\",\"misc_noting.md\":\"97300c71\",\"virtualization_arm_theory_io_m.md\":\"a3fd4479\",\"virtualization_x86_theory_io_virtio_noting.md\":\"ea8f1cd1\",\"virtualization_x86_kvm_interrupt_int-mapping_noting.md\":\"261c0bed\",\"virtualization_x86_theory_interrupt_int-mapping_noting.md\":\"ab4def10\",\"virtualization_x86_theory_io_full_noting.md\":\"cc7ca10c\",\"virtualization_x86_theory_interrupt_full_noting.md\":\"3b9f4c17\",\"virtualization_x86_kvm_noting.md\":\"efeb69de\",\"tools_debugger_addresssanitizer_readme.md\":\"dc6660b1\",\"tools_debugger_addresssanitizer_noting.md\":\"87a80785\",\"tools_debugger_strace_noting.md\":\"30c134e9\",\"tools_version_git_git.md\":\"88f5ea9f\",\"tools_debugger_valgrind_noting.md\":\"32199925\",\"virtualization_x86_qemu_net_noting.md\":\"397ccd2a\",\"virtualization_x86_kvm_interupt_noting.md\":\"7736e16a\",\"virtualization_x86_tools_virt-install_noting.md\":\"2e31fc33\",\"tools_debugger_crash_qcom-ramdump_qcom-ramdump.md\":\"136c1c6e\",\"linux_process_pelt_pelt.md\":\"166a548f\",\"linux_selinux_androidselinux_selinux.md\":\"f16cdb46\",\"linux_process_weight_weight.md\":\"1ea4451b\",\"linux_process_weight_weight-b.md\":\"c8ad206f\"}")</script>
    <script type="module" async src="/assets/app.4b3fa60d.js"></script>
    
  </body>
</html>
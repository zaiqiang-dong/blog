import{_ as A,c as t,a as p,b as s,d as a,w as n,e,r as l,o as c}from"./app.1d82c183.js";const B=JSON.parse('{"title":"页面分配基本流程","description":"","frontmatter":{},"headers":[{"level":2,"title":"1. 接口函数","slug":"_1-接口函数","link":"#_1-接口函数","children":[{"level":3,"title":"1.1 alloc_page","slug":"_1-1-alloc-page","link":"#_1-1-alloc-page","children":[]},{"level":3,"title":"1.2 __get_free_pages","slug":"_1-2-get-free-pages","link":"#_1-2-get-free-pages","children":[]},{"level":3,"title":"1.3 __get_free_page","slug":"_1-3-get-free-page","link":"#_1-3-get-free-page","children":[]},{"level":3,"title":"1.4 get_zeroed_page","slug":"_1-4-get-zeroed-page","link":"#_1-4-get-zeroed-page","children":[]},{"level":3,"title":"1.5 __get_dma_pages","slug":"_1-5-get-dma-pages","link":"#_1-5-get-dma-pages","children":[]}]},{"level":2,"title":"2. alloc_pages","slug":"_2-alloc-pages","link":"#_2-alloc-pages","children":[{"level":3,"title":"2.1 alloc_pages_node","slug":"_2-1-alloc-pages-node","link":"#_2-1-alloc-pages-node","children":[]},{"level":3,"title":"2.2 __alloc_pages_node","slug":"_2-2-alloc-pages-node","link":"#_2-2-alloc-pages-node","children":[]},{"level":3,"title":"2.3 __alloc_pages","slug":"_2-3-alloc-pages","link":"#_2-3-alloc-pages","children":[]}]},{"level":2,"title":"3. __alloc_pages_nodemask","slug":"_3-alloc-pages-nodemask","link":"#_3-alloc-pages-nodemask","children":[]},{"level":2,"title":"4. 小结","slug":"_4-小结","link":"#_4-小结","children":[]}],"relativePath":"linux/memory/buddy/alloc-pages/alloc-pages.md"}'),C={name:"linux/memory/buddy/alloc-pages/alloc-pages.md"},_=e(`<h1 id="页面分配基本流程" tabindex="-1">页面分配基本流程 <a class="header-anchor" href="#页面分配基本流程" aria-hidden="true">#</a></h1><hr><table><thead><tr><th>软件版本</th><th>硬件版本</th><th>更新内容</th></tr></thead><tbody><tr><td>linux 5.8.18</td><td>arm64</td><td></td></tr></tbody></table><hr><p>本章只是梳理页面分配流程，不存在代码思想的解析。</p><h2 id="_1-接口函数" tabindex="-1">1. 接口函数 <a class="header-anchor" href="#_1-接口函数" aria-hidden="true">#</a></h2><h3 id="_1-1-alloc-page" tabindex="-1">1.1 alloc_page <a class="header-anchor" href="#_1-1-alloc-page" aria-hidden="true">#</a></h3><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">alloc_page</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">gfp_mask</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">alloc_pages</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div>`,8),d=p("code",null,"alloc_page",-1),m=p("code",null,"alloc_pages",-1),b={class:"MathJax",jax:"SVG",style:{direction:"ltr",position:"relative"}},g={style:{overflow:"visible","min-height":"1px","min-width":"1px","vertical-align":"0"},xmlns:"http://www.w3.org/2000/svg",width:"2.119ex",height:"1.887ex",role:"img",focusable:"false",viewBox:"0 -833.9 936.6 833.9","aria-hidden":"true"},u=e('<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z" style="stroke-width:3;"></path></g><g data-mml-node="mn" transform="translate(533,363) scale(0.707)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" style="stroke-width:3;"></path></g></g></g></g>',1),f=[u],h=e(`<h3 id="_1-2-get-free-pages" tabindex="-1">1.2 __get_free_pages <a class="header-anchor" href="#_1-2-get-free-pages" aria-hidden="true">#</a></h3><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">unsigned</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__get_free_pages</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">gfp_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">unsigned</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">order</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> page </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">page</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	page </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">alloc_pages</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">gfp_mask </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">~</span><span style="color:#F07178;">__GFP_HIGHMEM</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> order</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(!</span><span style="color:#F07178;">page</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">unsigned</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">long</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">page_address</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">page</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>同样的<code>__get_free_pages</code>也是调用了调用了<code>alloc_pages</code>,只是在<code>gfp_mask</code>参数部分清除了<code>__GFP_HIGHMEM</code>,也就是不能从高端内存部分分配。这里最后一行<code>page_address</code>,表示返回的是页面的虚拟地址。</p><h3 id="_1-3-get-free-page" tabindex="-1">1.3 __get_free_page <a class="header-anchor" href="#_1-3-get-free-page" aria-hidden="true">#</a></h3><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__get_free_page</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">gfp_mask</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#82AAFF;">__get_free_pages</span><span style="color:#89DDFF;">((</span><span style="color:#A6ACCD;">gfp_mask</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这个很明显调用了<code>__get_free_pages</code>,只是页面个数为1.</p><h3 id="_1-4-get-zeroed-page" tabindex="-1">1.4 get_zeroed_page <a class="header-anchor" href="#_1-4-get-zeroed-page" aria-hidden="true">#</a></h3><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">unsigned</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">get_zeroed_page</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">gfp_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">gfp_mask</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">__get_free_pages</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">gfp_mask </span><span style="color:#89DDFF;">|</span><span style="color:#F07178;"> __GFP_ZERO</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这个函数调用了上面的<code>__get_free_pages</code>,只是设置了<code>__GFP_ZERO</code>,表示需要将页面进行清0处理。另外页面个数部分为0,表示只分配一个页面。</p><h3 id="_1-5-get-dma-pages" tabindex="-1">1.5 __get_dma_pages <a class="header-anchor" href="#_1-5-get-dma-pages" aria-hidden="true">#</a></h3><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__get_dma_pages</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">order</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#82AAFF;">__get_free_pages</span><span style="color:#89DDFF;">((</span><span style="color:#A6ACCD;">gfp_mask</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> GFP_DMA</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">order</span><span style="color:#89DDFF;">))</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>这里同样调用了<code>__get_free_pages</code>,只是设置了<code>GFP_DMA</code>,表示从DMA内存分区进行内存分配。</p><h2 id="_2-alloc-pages" tabindex="-1">2. alloc_pages <a class="header-anchor" href="#_2-alloc-pages" aria-hidden="true">#</a></h2><p>从上面的接口分析中可以看出所有的接口最终都是调用了<code>alloc_pages</code>,下面我重点分析这个函数。</p><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">#ifdef</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">CONFIG_NUMA</span></span>
<span class="line"><span style="color:#C792EA;">extern</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> page </span><span style="color:#89DDFF;">*</span><span style="color:#82AAFF;">alloc_pages_current</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">gfp_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">unsigned</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">order</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">inline</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> page </span><span style="color:#89DDFF;">*</span></span>
<span class="line"><span style="color:#82AAFF;">alloc_pages</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">gfp_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">unsigned</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">order</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">alloc_pages_current</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> order</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#C792EA;">extern</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> page </span><span style="color:#89DDFF;">*</span><span style="color:#82AAFF;">alloc_pages_vma</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">gfp_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">order</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">			</span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> vm_area_struct </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">vma</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">unsigned</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">addr</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">			</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">node</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">bool</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">hugepage</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">alloc_hugepage_vma</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">vma</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">addr</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">order</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#82AAFF;">alloc_pages_vma</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> order</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> vma</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> addr</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">numa_node_id</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#else</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">alloc_pages</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">order</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#82AAFF;">alloc_pages_node</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">numa_node_id</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> order</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">alloc_pages_vma</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">order</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">vma</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">addr</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">node</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">false</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">\\</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#82AAFF;">alloc_pages</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> order</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">alloc_hugepage_vma</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">vma</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">addr</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">order</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#82AAFF;">alloc_pages</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> order</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#endif</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>从宏定义可以看出在<code>NUMA</code>和非<code>NUMA</code>,存在不同，我们这里按非<code>NUMA</code>来分析。也就是如下：</p><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">alloc_pages</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">order</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#82AAFF;">alloc_pages_node</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">numa_node_id</span><span style="color:#89DDFF;">(),</span><span style="color:#A6ACCD;"> gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> order</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>最终调用的是<code>alloc_pages_node</code>,这里的node是<code>NUMA</code>节点。这里<code>numa_node_id</code>返回的是当前<code>CPU</code>所在的<code>NUMA</code>节点，我们这里是讨论的是非<code>NUMA</code>平台，所以这里的节点值为0。</p><h3 id="_2-1-alloc-pages-node" tabindex="-1">2.1 alloc_pages_node <a class="header-anchor" href="#_2-1-alloc-pages-node" aria-hidden="true">#</a></h3><p>从上面的分析最终是调用了<code>alloc_pages_node</code>,代码如下：</p><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">inline</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> page </span><span style="color:#89DDFF;">*</span><span style="color:#82AAFF;">alloc_pages_node</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">nid</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">gfp_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">gfp_mask</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">						</span><span style="color:#C792EA;">unsigned</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">order</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">nid </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> NUMA_NO_NODE</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">		nid </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">numa_mem_id</span><span style="color:#89DDFF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">__alloc_pages_node</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">nid</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> order</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>代码很简单就是调用<code>__alloc_pages_node</code></p><h3 id="_2-2-alloc-pages-node" tabindex="-1">2.2 __alloc_pages_node <a class="header-anchor" href="#_2-2-alloc-pages-node" aria-hidden="true">#</a></h3><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">inline</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> page </span><span style="color:#89DDFF;">*</span></span>
<span class="line"><span style="color:#82AAFF;">__alloc_pages_node</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">nid</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">gfp_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">unsigned</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">order</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	/* 保证nid的合法性 */</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#82AAFF;">VM_BUG_ON</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">nid </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">||</span><span style="color:#F07178;"> nid </span><span style="color:#89DDFF;">&gt;=</span><span style="color:#F07178;"> MAX_NUMNODES</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#82AAFF;">VM_WARN_ON</span><span style="color:#89DDFF;">((</span><span style="color:#F07178;">gfp_mask </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> __GFP_THISNODE</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!</span><span style="color:#82AAFF;">node_online</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">nid</span><span style="color:#89DDFF;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">__alloc_pages</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> order</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> nid</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_2-3-alloc-pages" tabindex="-1">2.3 __alloc_pages <a class="header-anchor" href="#_2-3-alloc-pages" aria-hidden="true">#</a></h3><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> page </span><span style="color:#89DDFF;">*</span></span>
<span class="line"><span style="color:#82AAFF;">__alloc_pages_nodemask</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">gfp_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">unsigned</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">order</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">preferred_nid</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">							</span><span style="color:#FFCB6B;">nodemask_t</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">nodemask</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">inline</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> page </span><span style="color:#89DDFF;">*</span></span>
<span class="line"><span style="color:#82AAFF;">__alloc_pages</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">gfp_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">unsigned</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">order</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">preferred_nid</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">__alloc_pages_nodemask</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> order</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> preferred_nid</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">NULL);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>上面代码很简单，<code>__alloc_pages_nodemask</code>是真正的内存分配函数。</p><h2 id="_3-alloc-pages-nodemask" tabindex="-1">3. __alloc_pages_nodemask <a class="header-anchor" href="#_3-alloc-pages-nodemask" aria-hidden="true">#</a></h2><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> page </span><span style="color:#89DDFF;">*</span></span>
<span class="line"><span style="color:#82AAFF;">__alloc_pages_nodemask</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">gfp_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">unsigned</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">order</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">preferred_nid</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">							</span><span style="color:#FFCB6B;">nodemask_t</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">nodemask</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> page </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">page</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#C792EA;">unsigned</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">int</span><span style="color:#F07178;"> alloc_flags </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> ALLOC_WMARK_LOW</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#FFCB6B;">gfp_t</span><span style="color:#F07178;"> alloc_mask</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;"> /* The gfp_t that was actually used for allocation */</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> alloc_context ac </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * There are several places where we assume that the order value is sane</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * so bail out early if the request is out of bound.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 */</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">unlikely</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">order </span><span style="color:#89DDFF;">&gt;=</span><span style="color:#F07178;"> MAX_ORDER</span><span style="color:#89DDFF;">))</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#82AAFF;">WARN_ON_ONCE</span><span style="color:#89DDFF;">(!(</span><span style="color:#F07178;">gfp_mask </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> __GFP_NOWARN</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">NULL;</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * gfp_allowed_mask 在系统启动中为GFP_BOOT_MASK</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * #define GFP_BOOT_MASK (__GFP_BITS_MASK &amp; ~(__GFP_RECLAIM|__GFP_IO|__GFP_FS))</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 *</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * 后设置为如下</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * gfp_allowed_mask = __GFP_BITS_MASK; = 0x7FFFFF;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 *</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 */</span></span>
<span class="line"><span style="color:#F07178;">	gfp_mask </span><span style="color:#89DDFF;">&amp;=</span><span style="color:#F07178;"> gfp_allowed_mask</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	alloc_mask </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> gfp_mask</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * prepare_alloc_pages 主要是初始化ac，具体见函数实现</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 */</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(!</span><span style="color:#82AAFF;">prepare_alloc_pages</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> order</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> preferred_nid</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> nodemask</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;">ac</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;">alloc_mask</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;">alloc_flags</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">NULL;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * 这里主要是要找一个最好的zone用于后面分配内存</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 *</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * */</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#82AAFF;">finalise_ac</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;">ac</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * Forbid the first pass from falling back to types that fragment</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * memory until all local zones are considered.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 */</span></span>
<span class="line"><span style="color:#F07178;">	alloc_flags </span><span style="color:#89DDFF;">|=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">alloc_flags_nofragment</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ac</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">preferred_zoneref</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">zone</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> gfp_mask</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * 大部分情况会走这里</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 */</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	/* First allocation attempt */</span></span>
<span class="line"><span style="color:#F07178;">	page </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">get_page_from_freelist</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">alloc_mask</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> order</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> alloc_flags</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;">ac</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">likely</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">page</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;font-style:italic;">goto</span><span style="color:#F07178;"> out</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * Apply scoped allocation constraints. This is mainly about GFP_NOFS</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * resp. GFP_NOIO which has to be inherited for all allocation requests</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * from a particular context which has been marked by</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * memalloc_no{fs,io}_{save,restore}.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 */</span></span>
<span class="line"><span style="color:#F07178;">	alloc_mask </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">current_gfp_context</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">gfp_mask</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#A6ACCD;">ac</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">spread_dirty_pages</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">false;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * Restore the original nodemask if it was potentially replaced with</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * &amp;cpuset_current_mems_allowed to optimize the fast-path attempt.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 */</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#A6ACCD;">ac</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">nodemask</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> nodemask</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * 系统内存不足，先回收再分配</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	page </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">__alloc_pages_slowpath</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">alloc_mask</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> order</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;">ac</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">out:</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">memcg_kmem_enabled</span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">gfp_mask </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> __GFP_ACCOUNT</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> page </span><span style="color:#89DDFF;">&amp;&amp;</span></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#82AAFF;">unlikely</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">__memcg_kmem_charge_page</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">page</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> gfp_mask</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> order</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">))</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#82AAFF;">__free_pages</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">page</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> order</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">		page </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">NULL;</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#82AAFF;">trace_mm_page_alloc</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">page</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> order</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> alloc_mask</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">ac</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">migratetype</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> page</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br></div></div><h2 id="_4-小结" tabindex="-1">4. 小结 <a class="header-anchor" href="#_4-小结" aria-hidden="true">#</a></h2><p>本文只是梳理了大体的内存页面分配的思路，从上面代码分析中可以看到<code>__alloc_pages_nodemask</code>才是真正的分配函数，无论你调用了那个接口函数，最终都会调到这里。</p><hr><div class="tip custom-block"><p class="custom-block-title">提示</p><p>欢迎评论、探讨,如果发现错误请指正。转载请注明出处！ <a href="http://www.tsz.wiki" target="_blank" rel="noreferrer">探索者</a></p></div><hr>`,34);function k(r,E,v,T,x,w){const o=l("mn"),y=l("msup"),i=l("math"),F=l("mjx-assistive-mml"),D=l("Vssue");return c(),t("div",null,[_,p("p",null,[s("从代码可以看出"),d,s("最终调用的是"),m,s(",只是在第二个参数的位置写0,表示 "),p("mjx-container",b,[(c(),t("svg",g,f)),a(F,{unselectable:"on",display:"inline",style:{top:"0px",left:"0px",clip:"rect(1px, 1px, 1px, 1px)","-webkit-touch-callout":"none","-webkit-user-select":"none","-khtml-user-select":"none","-moz-user-select":"none","-ms-user-select":"none","user-select":"none",position:"absolute",padding:"1px 0px 0px 0px",border:"0px",display:"block",width:"auto",overflow:"hidden"}},{default:n(()=>[a(i,{xmlns:"http://www.w3.org/1998/Math/MathML"},{default:n(()=>[a(y,null,{default:n(()=>[a(o,null,{default:n(()=>[s("2")]),_:1}),a(o,null,{default:n(()=>[s("0")]),_:1})]),_:1})]),_:1})]),_:1})]),s(",也就是1个页面。")]),h,a(D,{title:r.$title},null,8,["title"])])}const M=A(C,[["render",k]]);export{B as __pageData,M as default};
